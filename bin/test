#!/usr/bin/env node
var fs = require('fs');
var path = require('path');
var Mocha = require('mocha');

var fakeServers = require('../test/support/fake-servers.js');

process.env.LEAPHOME_ENV = process.env.LEAPHOME_ENV || 'test';

var projectDir = path.join(__dirname, '..');
var queue = [];
var testFiles = process.argv.slice(2);
if (testFiles.length === 0) {
  queue = [ path.join(projectDir, 'test') ];
} else {
  for (var i = 0; i < testFiles.length; i++) {
    var testFile = testFiles[i];
    if (fs.statSync(testFile).isDirectory()) {
      queue.push(testFile);
      testFiles.splice(i, 1);
      i--;
    }
  }
}


while (queue.length > 0) {
  var currentFile = queue.shift();
  if (fs.statSync(currentFile).isDirectory()) {
    fs.readdirSync(currentFile).forEach(function(containedFile) {
      queue.push(path.join(currentFile, containedFile));
    });
  } else if (/^test.*\.js$/.test(path.basename(currentFile))) {
    testFiles.push(currentFile);
  }
}

console.log('Testing file' + (testFiles.length > 1 ? 's' : '') + ': ' + testFiles.join(', '));

var mocha = new Mocha();
testFiles.forEach(function(testFile) {
  mocha.addFile(testFile);
});
fakeServers.start(function() {
  mocha.run(function() {
    fakeServers.stop();
    process.exit();
  });
});

